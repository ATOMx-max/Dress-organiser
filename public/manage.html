<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Sections & Categories | Dress Organizer</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 25px;
      overflow-x: hidden;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 30px;
    }

    header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .btn {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      border: none;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 50px;
      padding: 10px 25px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 8px 20px rgba(79,70,229,0.3);
    }

    .btn:hover { transform: scale(1.05); }

    .btn.logout {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .panel {
      background: rgba(255,255,255,0.97);
      border-radius: 20px;
      padding: 25px;
      max-width: 900px;
      margin: 0 auto 25px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.15);
      color: #333;
    }

    .panel h2 {
      color: #4f46e5;
      font-size: 1.5rem;
      margin-bottom: 15px;
      text-align: center;
    }

    .input-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    input, select {
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      flex: 1;
      min-width: 220px;
      transition: 0.3s;
    }

    input:focus, select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .tag {
      background: #f3f4f6;
      color: #1f2937;
      border-radius: 20px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .tag span {
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 20px;
      cursor: pointer;
    }

    .reset-btn {
      display: block;
      margin: 20px auto;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      border: none;
      padding: 10px 25px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(16,185,129,0.3);
      transition: 0.3s;
    }

    .reset-btn:hover { transform: scale(1.05); }

    .loader {
      text-align: center;
      font-weight: bold;
      color: #fff;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <h1>‚öôÔ∏è Manage Sections & Categories</h1>
    <button class="btn logout" id="logoutBtn">Logout</button>
  </header>

  <!-- SECTION PANEL -->
  <div class="panel">
    <h2>üß© Add Section</h2>
    <div class="input-row">
      <input type="text" id="sectionInput" placeholder="Enter new section">
      <button class="btn" id="addSectionBtn">Add Section</button>
    </div>
    <div class="tag-container" id="sectionList"></div>
  </div>

  <!-- CATEGORY PANEL -->
  <div class="panel">
    <h2>üìÇ Add Category</h2>
    <div class="input-row">
      <select id="sectionSelect"><option value="">Select Section</option></select>
      <input type="text" id="categoryInput" placeholder="Enter new category">
      <button class="btn" id="addCategoryBtn">Add Category</button>
    </div>
    <div class="tag-container" id="categoryList"></div>
  </div>

  <!-- RESET DEFAULTS -->
  <button class="reset-btn" onclick="resetDefaults()">‚ôª Reset to Default</button>

  <!-- BACK BUTTON -->
  <div style="display:flex; justify-content:center; margin-top:30px;">
    <button class="btn" onclick="window.location.href='dashboard.html'"
      style="background:linear-gradient(135deg,#10b981,#059669);padding:12px 30px;">
      ‚Üê Dashboard
    </button>
  </div>

  <div id="loader" class="loader"></div>

  <!-- MAIN SCRIPT -->
  <script>
    const API_URL = window.location.origin.includes("localhost")
      ? "http://localhost:8080/api"
      : "https://dress-organiser.onrender.com/api";

    // ============================
    //  SESSION CHECK
    // ============================
    async function checkSession() {
      const res = await fetch(`${API_URL}/sections`, { credentials: "include" });
      if (res.status === 401) {
        localStorage.removeItem("loggedInUser");
        window.location.href = "login.html";
      }
    }

    // ============================
    //  LOGOUT BUTTON
    // ============================
    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    };

    // DOM elements
    const sectionList = document.getElementById("sectionList");
    const sectionSelect = document.getElementById("sectionSelect");
    const categoryList = document.getElementById("categoryList");
    const loader = document.getElementById("loader");

    // ============================
    //  LOAD SECTIONS
    // ============================
    async function loadSections() {
      loader.textContent = "Loading sections...";
      const res = await fetch(`${API_URL}/sections`, { credentials: "include" });
      const data = await res.json();
      loader.textContent = "";
      renderSections(data);
    }

    function renderSections(sections) {
      sectionList.innerHTML = "";
      sectionSelect.innerHTML = `<option value="">Select Section</option>`;

      sections.forEach(sec => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerHTML = `${sec.name} <span onclick="deleteSection('${sec.name}')">√ó</span>`;
        sectionList.appendChild(tag);

        const opt = document.createElement("option");
        opt.value = sec.name;
        opt.textContent = sec.name;
        sectionSelect.appendChild(opt);
      });
    }

    // ============================
    //  ADD SECTION
    // ============================
    async function addSection() {
      const name = document.getElementById("sectionInput").value.trim();
      if (!name) return alert("Enter a section name!");

      const res = await fetch(`${API_URL}/sections`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ name }),
      });

      const data = await res.json();
      alert(data.message);
      document.getElementById("sectionInput").value = "";
      loadSections();
    }

    // ============================
    //  DELETE SECTION
    // ============================
    async function deleteSection(name) {
      if (!confirm(`Delete section '${name}' and all related dresses?`)) return;

      const res = await fetch(`${API_URL}/sections/${name}`, {
        method: "DELETE",
        credentials: "include"
      });

      const data = await res.json();
      alert(data.message);
      loadSections();
      categoryList.innerHTML = "";
    }

    // ============================
    //  LOAD CATEGORIES
    // ============================
    async function loadCategories() {
      categoryList.innerHTML = "";
      const sectionName = sectionSelect.value;

      if (!sectionName) return;

      const res = await fetch(`${API_URL}/sections`, { credentials: "include" });
      const data = await res.json();

      const sec = data.find(s => s.name === sectionName);
      if (!sec) return;

      sec.categories.forEach(cat => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerHTML = `${cat} <span onclick="deleteCategory('${sectionName}','${cat}')">√ó</span>`;
        categoryList.appendChild(tag);
      });
    }

    // ============================
    //  ADD CATEGORY
    // ============================
    async function addCategory() {
      const sectionName = sectionSelect.value;
      const category = document.getElementById("categoryInput").value.trim();

      if (!sectionName) return alert("Select a section first!");
      if (!category) return alert("Enter a category name!");

      const res = await fetch(`${API_URL}/categories`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ sectionName, category }),
      });

      const data = await res.json();
      alert(data.message);

      document.getElementById("categoryInput").value = "";
      loadCategories();
    }

    // ============================
    //  DELETE CATEGORY
    // ============================
    async function deleteCategory(section, category) {
      if (!confirm(`Delete category '${category}'?`)) return;

      const res = await fetch(`${API_URL}/categories/${section}/${category}`, {
        method: "DELETE",
        credentials: "include"
      });

      const data = await res.json();
      alert(data.message);
      loadCategories();
    }

    // ============================
    //  RESET DEFAULT VALUES
    // ============================
    async function resetDefaults() {
      if (!confirm("Reset all sections & categories to default?")) return;

      const res = await fetch(`${API_URL}/reset-defaults`, {
        method: "POST",
        credentials: "include"
      });

      const data = await res.json();
      alert(data.message);

      loadSections();
      categoryList.innerHTML = "";
    }

    // ============================
    //  EVENT LISTENERS
    // ============================
    document.getElementById("addSectionBtn").onclick = addSection;
    document.getElementById("addCategoryBtn").onclick = addCategory;
    sectionSelect.onchange = loadCategories;

    // ============================
    //  SAFE STARTUP
    // ============================
    (async () => {
      await checkSession();
      loadSections();
    })();
  </script>

</body>
</html>
