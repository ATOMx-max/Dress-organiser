<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email Verification | Dress Organizer</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    :root{
      --bg1:#1e1b4b;
      --bg2:#312e81;
      --bg3:#4c1d95;
      --accent1:#818cf8;
      --accent2:#c084fc;
      --muted:#c7d2fe;
      --success:#10b981;
      --error:#ef4444;
    }

    body{
      font-family:"Inter",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:white;
      position:relative;
      overflow:hidden;
    }

    /* Floating Orbs */
    .orb{
      position:absolute;
      border-radius:50%;
      filter:blur(90px);
      opacity:0.18;
      animation:float 20s infinite ease-in-out;
      z-index:0;
    }
    .orb-1{width:500px;height:500px;top:-180px;left:-160px;background:linear-gradient(135deg,#818cf8,#c084fc);}
    .orb-2{width:400px;height:400px;bottom:-160px;right:-140px;background:linear-gradient(135deg,#f472b6,#fb923c);animation-delay:4s;}
    .orb-3{width:360px;height:360px;top:40%;left:50%;transform:translate(-50%, -50%);background:linear-gradient(135deg,#06b6d4,#3b82f6);animation-delay:8s;}

    @keyframes float{
      0%,100%{transform:translate(0,0) scale(1);}
      40%{transform:translate(40px,-40px) scale(1.1);}
      70%{transform:translate(-30px,30px) scale(.9);}
    }

    /* Main Card */
    .card{
      width:100%;
      max-width:520px;
      padding:40px;
      border-radius:26px;
      backdrop-filter:blur(22px);
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.14);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      z-index:10;
      text-align:center;
      animation:popIn .65s cubic-bezier(0.16,1,0.3,1);
    }

    @keyframes popIn{
      from{opacity:0;transform:translateY(30px) scale(.96);}
      to{opacity:1;transform:translateY(0) scale(1);}
    }

    /* Icon Container */
    .icon-container{
      width:100px;height:100px;
      display:flex;justify-content:center;align-items:center;
      font-size:50px;
      margin:0 auto 24px;
      border-radius:50%;
      animation:floatIcon 3s infinite ease-in-out;
    }

    @keyframes floatIcon{
      0%,100%{transform:translateY(0);}
      50%{transform:translateY(-10px);}
    }

    .icon-container.loading{
      background:linear-gradient(135deg,#818cf8,#c084fc);
      box-shadow:0 10px 30px rgba(129,140,248,0.3);
    }

    .icon-container.success{
      background:linear-gradient(135deg,#10b981,#06b6d4);
      box-shadow:0 10px 30px rgba(16,185,129,0.3);
    }

    .icon-container.error{
      background:linear-gradient(135deg,#ef4444,#f97316);
      box-shadow:0 10px 30px rgba(239,68,68,0.3);
    }

    /* Spinner */
    .spinner{
      width:40px;height:40px;
      border:4px solid rgba(255,255,255,0.3);
      border-top-color:white;
      border-radius:50%;
      animation:spin .8s linear infinite;
    }

    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    h2{
      margin-bottom:12px;
      font-size:28px;
    }

    p{
      color:var(--muted);
      line-height:1.6;
      margin-bottom:12px;
    }

    /* Button */
    .btn{
      display:inline-block;
      padding:14px 32px;
      border:none;
      border-radius:12px;
      margin-top:20px;
      font-size:15px;
      font-weight:700;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      color:white;
      cursor:pointer;
      transition:.2s;
      box-shadow:0 10px 26px rgba(129,140,248,0.3);
      text-decoration:none;
    }

    .btn:hover{
      transform:translateY(-3px);
      box-shadow:0 12px 30px rgba(129,140,248,0.4);
    }

    .hidden{
      display:none;
    }

    /* Status Messages */
    .status-content{
      animation:fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn{
      from{opacity:0;}
      to{opacity:1;}
    }
  </style>
</head>

<body>

  <!-- Background Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="card">
    
    <!-- Loading State -->
    <div id="loadingState" class="status-content">
      <div class="icon-container loading">
        <div class="spinner"></div>
      </div>
      <h2>Verifying Your Email</h2>
      <p>Please wait while we verify your email address...</p>
    </div>

    <!-- Success State -->
    <div id="successState" class="status-content hidden">
      <div class="icon-container success">
        ✅
      </div>
      <h2>Email Verified Successfully!</h2>
      <p>Your email has been verified. You can now log in to your account.</p>
      <p style="font-size:14px;margin-top:16px;">Redirecting to login page in <span id="countdown">3</span> seconds...</p>
      <a href="login.html" class="btn">Go to Login</a>
    </div>

    <!-- Error State -->
    <div id="errorState" class="status-content hidden">
      <div class="icon-container error">
        ❌
      </div>
      <h2>Verification Failed</h2>
      <p id="errorMessage">The verification link is invalid or has expired.</p>
      <p style="font-size:14px;margin-top:16px;">Please try registering again or contact support if the problem persists.</p>
      <a href="register.html" class="btn">Back to Register</a>
    </div>

    <!-- Invalid Link State -->
    <div id="invalidState" class="status-content hidden">
      <div class="icon-container error">
        ⚠️
      </div>
      <h2>Invalid Verification Link</h2>
      <p>The verification link appears to be incomplete or invalid.</p>
      <p style="font-size:14px;margin-top:16px;">Please check your email and click the verification link again.</p>
      <a href="login.html" class="btn">Go to Login</a>
    </div>

  </div>

<script>
const API_URL = window.location.origin.includes("localhost")
  ? "http://localhost:8080"
  : "https://dress-organiser.onrender.com";

// Get elements
const loadingState = document.getElementById("loadingState");
const successState = document.getElementById("successState");
const errorState = document.getElementById("errorState");
const invalidState = document.getElementById("invalidState");
const errorMessage = document.getElementById("errorMessage");
const countdownSpan = document.getElementById("countdown");

// Parse URL parameters
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    token: params.get("token"),
    id: params.get("id"),
    status: params.get("status")
  };
}

// Show specific state
function showState(state) {
  loadingState.classList.add("hidden");
  successState.classList.add("hidden");
  errorState.classList.add("hidden");
  invalidState.classList.add("hidden");
  
  state.classList.remove("hidden");
}

// Countdown and redirect
function startCountdown() {
  let count = 3;
  const interval = setInterval(() => {
    count--;
    countdownSpan.textContent = count;
    
    if (count <= 0) {
      clearInterval(interval);
      window.location.href = "login.html";
    }
  }, 1000);
}

// Verify email function
async function verifyEmail(token, id) {
  try {
    const response = await fetch(`${API_URL}/verify?token=${encodeURIComponent(token)}&id=${encodeURIComponent(id)}`, {
      method: "GET",
      credentials: "include"
    });

    // The backend redirects, but we can also check if we're on the verify page with status
    const currentParams = getQueryParams();
    
    if (currentParams.status === "success") {
      showState(successState);
      startCountdown();
    } else if (currentParams.status === "invalid") {
      errorMessage.textContent = "The verification link is invalid or has already been used.";
      showState(errorState);
    } else if (currentParams.status === "error") {
      errorMessage.textContent = "An error occurred during verification. Please try again.";
      showState(errorState);
    } else {
      // If no status but we have token and id, wait for redirect
      setTimeout(() => {
        const params = getQueryParams();
        if (!params.status) {
          // Still no status after wait, might be an error
          errorMessage.textContent = "Verification timed out. Please try again.";
          showState(errorState);
        }
      }, 5000);
    }

  } catch (error) {
    console.error("Verification error:", error);
    errorMessage.textContent = "Unable to connect to the server. Please check your internet connection.";
    showState(errorState);
  }
}

// Initialize verification
async function init() {
  const { token, id, status } = getQueryParams();

  // If status is already in URL (from backend redirect)
  if (status) {
    if (status === "success") {
      showState(successState);
      startCountdown();
    } else if (status === "invalid") {
      errorMessage.textContent = "The verification link is invalid or has already been used.";
      showState(errorState);
    } else if (status === "error") {
      errorMessage.textContent = "An error occurred during verification. Please try again.";
      showState(errorState);
    }
    return;
  }

  // If we have token and id, proceed with verification
  if (token && id) {
    await verifyEmail(token, id);
  } else {
    // No token or id in URL
    showState(invalidState);
  }
}

// Start verification on page load
window.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>