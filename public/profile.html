<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings | Dress Organizer</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
      color: white;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,0.12);
      padding: 25px;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .nav-item {
      padding: 12px 14px;
      margin-bottom: 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.25s;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.18);
    }

    .active {
      background: rgba(255,255,255,0.25);
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .subtitle {
      color: #c7d2fe;
      margin-bottom: 30px;
    }

    /* CARD */
    .card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(18px);
      padding: 25px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.15);
      margin-bottom: 30px;
    }

    /* Profile Pic */
    .profile-pic-box {
      text-align: center;
      margin-bottom: 25px;
    }

    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255,255,255,0.4);
    }

    .upload-btn {
      margin-top: 12px;
      padding: 8px 18px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }

    /* INFO ROW */
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      align-items: center;
    }

    .info-label { color: #c7d2fe; font-size: 0.95rem; }
    .info-value { font-size: 1rem; font-weight: 600; }

    .edit-btn {
      padding: 6px 14px;
      background: rgba(255,255,255,0.12);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.18);
      cursor: pointer;
    }

    .badge {
      padding: 6px 14px;
      border-radius: 14px;
    }

    .badge.green {
      background: rgba(0,255,120,0.2);
      color: #bbf7d0;
    }

    .badge.red {
      background: rgba(255,0,0,0.2);
      color: #fecaca;
    }

    /* MODAL */
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

    .modal {
      background: rgba(255,255,255,0.1);
      padding: 25px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.12);
      color: white;
    }

    .btn-danger {
      background: rgba(255,0,0,0.25) !important;
      border: 1px solid rgba(255,0,0,0.4) !important;
    }

    .close {
      float: right;
      cursor: pointer;
      font-size: 20px;
    }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Dress Organizer</h2>

  <div class="nav-item" onclick="location.href='dashboard.html'">üè† Dashboard</div>
  <div class="nav-item" onclick="location.href='all-dresses.html'">üëó All Dresses</div>
  <div class="nav-item" onclick="location.href='upload.html'">‚¨ÜÔ∏è Upload Dress</div>
  <div class="nav-item" onclick="location.href='manage.html'">üìÇ Manage</div>
  <div class="nav-item" onclick="location.href='search.html'">üîç Search</div>
  <div class="nav-item" onclick="location.href='favourites.html'">‚ù§Ô∏è Favourites</div>

  <div class="nav-item active">‚öôÔ∏è Settings</div>

  <div class="nav-item" onclick="logout()">üö™ Logout</div>
</div>

<!-- MAIN AREA -->
<div class="main">
  <h1>Account Settings</h1>
  <p class="subtitle">Manage your profile, password, and preferences</p>

  <!-- Profile picture -->
  <div class="card">
    <div class="profile-pic-box">
      <img id="profilePic" class="profile-pic" src="default.jpg" />
      <br />
      <label class="upload-btn">
        Upload New Photo
        <input type="file" id="picInput" accept="image/*" hidden>
      </label>
    </div>
  </div>

  <!-- INFO -->
  <div class="card">

    <div class="info-row">
      <span class="info-label">üßç Name</span>
      <span class="info-value" id="name"></span>
      <button class="edit-btn" onclick="editName()">Edit</button>
    </div>

    <div class="info-row">
      <span class="info-label">üÜî Username</span>
      <span class="info-value" id="username"></span>
      <button class="edit-btn" onclick="editUsername()">Edit</button>
    </div>

    <div class="info-row">
      <span class="info-label">üìß Email</span>
      <span class="info-value" id="email"></span>
    </div>

    <div class="info-row">
      <span class="info-label">‚úî Status</span>
      <span id="verifyBadge"></span>
      <button class="edit-btn" onclick="resendVerification()">Resend</button>
    </div>

    <div class="info-row">
      <span class="info-label">üìÖ Joined</span>
      <span class="info-value" id="joined"></span>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <button onclick="openPasswordModal()">üîê Change Password</button>
  <button class="btn-danger" onclick="openDeleteModal()">üóë Delete Account</button>

</div>

<!-- PASSWORD MODAL -->
<div id="passwordModal" class="modal-bg">
  <div class="modal">
    <span class="close" onclick="closePasswordModal()">‚úñ</span>
    <h2>Change Password</h2>

    <input id="curPass" class="input" type="password" placeholder="Current Password">
    <input id="newPass" class="input" type="password" placeholder="New Password">

    <button onclick="changePassword()">Update Password</button>
  </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal-bg">
  <div class="modal">
    <span class="close" onclick="closeDeleteModal()">‚úñ</span>
    <h2>Delete Account</h2>
    <p>This action is permanent.</p>
    <button class="btn-danger" onclick="deleteAccount()">DELETE</button>
  </div>
</div>

<script>
  const API_URL = window.location.origin.includes("localhost")
    ? "http://localhost:8080"
    : "https://dress-organiser.onrender.com";

  /* LOAD USER DETAILS */
  async function loadUser() {
    const res = await fetch(`${API_URL}/api/me`, { credentials: "include" });
    if (!res.ok) return location.href = "login.html";

    const user = await res.json();

    name.textContent = user.name || "Not set";
    username.textContent = user.username || "Not set";
    email.textContent = user.email;

    joined.textContent = new Date(user.joined).toLocaleDateString("en-IN");

    profilePic.src = user.profilePic || "default.jpg";

    verifyBadge.innerHTML = user.verified
      ? `<span class='badge green'>Verified</span>`
      : `<span class='badge red'>Not Verified</span>`;
  }

  /* NAME EDIT */
  function editName() {
    const newName = prompt("Enter new name:");
    if (!newName) return;

    fetch(`${API_URL}/api/update-name`, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: newName })
    }).then(() => loadUser());
  }

  /* USERNAME EDIT */
  function editUsername() {
    const newUsername = prompt("Enter new username:");
    if (!newUsername) return;

    fetch(`${API_URL}/api/update-username`, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: newUsername })
    }).then(() => loadUser());
  }

  /* UPLOAD PROFILE PIC */
  picInput.addEventListener("change", async (e) => {
    const form = new FormData();
    form.append("image", e.target.files[0]);

    const res = await fetch(`${API_URL}/api/upload-profile-pic`, {
      method: "POST",
      credentials: "include",
      body: form
    });

    const data = await res.json();
    if (data.success) loadUser();
  });

  /* PASSWORD MODAL */
  function openPasswordModal() {
    passwordModal.style.display = "flex";
  }
  function closePasswordModal() {
    passwordModal.style.display = "none";
  }

  function changePassword() {
    const currentPassword = curPass.value;
    const newPassword = newPass.value;

    fetch(`${API_URL}/api/change-password`, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ currentPassword, newPassword })
    }).then(() => {
      alert("Password Updated!");
      closePasswordModal();
    });
  }

  /* RESEND VERIFICATION */
  function resendVerification() {
    fetch(`${API_URL}/api/resend-verification`, {
      method: "POST",
      credentials: "include"
    });
    alert("Verification email sent!");
  }

  /* DELETE MODAL */
  function openDeleteModal() {
    deleteModal.style.display = "flex";
  }
  function closeDeleteModal() {
    deleteModal.style.display = "none";
  }

  function deleteAccount() {
    fetch(`${API_URL}/api/delete-account`, {
      method: "DELETE",
      credentials: "include"
    }).then(() => {
      localStorage.clear();
      alert("Account deleted");
      location.href = "login.html";
    });
  }

  /* LOGOUT */
  function logout() {
    localStorage.clear();
    location.href = "login.html";
  }

  loadUser();
</script>

</body>
</html>
